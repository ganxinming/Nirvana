# Elastic-Job

Elastic-Job 最开始只有一个 elastic-job-core 的项目，定位轻量级、无中心化，最核心的服务就是支持弹性扩容和数据分片！

从 2.X 版本以后，主要分为 Elastic-Job-Lite 和 Elastic-Job-Cloud 两个子项目。

其中，Elastic-Job-Lite 定位为轻量级 无 中 心 化 解 决 方 案 ， 使 用`jar` 包 的 形 式 提 供 分 布 式 任 务 的 协 调 服 务 。

而 Elastic-Job-Cloud 使用 Mesos + Docker 的解决方案，额外提供资源治理、应用分发以及进程隔离等服务（跟 Lite 的区别只是部署方式不同，他们使用相同的 API，只要开发一次）。

## 什么是任务调度？

系统为了自动完成任务，在约定时间去调度任务。

(假如没有框架怎么办？1.多线程+sleep2.Timmer定时执行)

现有的任务调度框架：quartz，ScheduledExecutorService

## 功能

`Elastic-Job-Lite`，最主要的功能特性如下：

- 分布式调度协调：采用 zookeeper 实现注册中心，进行统一调度。
- 支持任务分片，并行调度：指将一个大任务分成多个小任务，在多个实例执行
- 支持弹性扩容缩容：将任务拆分为 n 个任务项后，各个服务器分别执行各自分配到的任务项。一旦有新的服务器加入集群，它应该能够被选举执行，当集群减少实例，所执行的任务能够转移到别的实例执行
- 高可用
- 失效转移：某实例在任务执行失败后，会被转移到其他实例执行
- 错过作业重新触发：某种原因导致作业错过执行，会自动记录错过执行的作业，并在上次作业完成后触发
- 任务管理和监听
- 避免任务重复执行(分布式锁实现)
- 作业分片一致性：保证同一个分片在分布式环境仅有一个实例
- 支持作业生命周期操作：可以动态的对任务开启和停止
- 丰富的作业类型：simple、DataFlow、script

![image-20210517215824936](../../../Library/Application Support/typora-user-images/image-20210517215824936.png)

## 依赖zk的作用？

1.依赖ZK完成对执行任务的信息存储（如任务的名称，执行任务的实例，执行策略等）

2.依赖ZK的选举机制，在机器数量发现变化时，快速触发选举哪个实例去执行。

### 选举Leader过程？

任意一个实例启动，会创建一个/server的持久节点

多个实例同时创建/server/leader的临时节点

/server/leader只能被一个创建成功，后创建的会失败，创建成功的会被选举为leader，用来执行任务

剩下的任务实例都会监听这个临时节点，如果该节点被删除，则重新进行选举抢占临时节点。

### 分片

就是将一个任务，分成多个子任务执行。实际上分片其实就相当于分多少片，则执行多少进程。如10片，则会在几台机器上平均分配(根据分片策略)10个任务进程执行。但是此时，只是单纯的将相同的任务进程执行，怎么分开执行任务，是需要用户自己去实现逻辑分片的

shardingTotalCount：指定分片数量

shardingItemParameters：指定分片参数(特别重要，0=pro-a,1=pro-b,2=pro-c,3=pro-c)，这样可以根据分片参数去数据查询数据库(前提是这些参数真的可以区分不同的数据，那么就可以根据各自分片的参数查询需要的数据)

通过：shardingContext.getShardingParameter（），可以拿到当前分片参数



最大限度利用资源：分片数大于机器数，最好是成倍的大于

比如三台机器9个分片：A:123,B:456,C:789

### 作业分片策略

平均分配策略(默认分配策略，缺点：一旦分片数不均，则分配任务总是分配给IP升序靠前的机器)

作业哈希奇偶数分配(哈希奇数则按IP升序分，偶数则按IP降序分，解决平均分的问题)

作业名哈希轮询(根据哈希值轮询服务器)



### DATAFLOW类型定时任务

需要实现DataFlowJob接口，覆盖两个方法，分别为抓取数据fetchData(即获取数据)和处理数据processData

